{% extends "app/structure/layout.html" %} {% block content %}

<div class="content-padded flex flex-col gap-y-4">
  <!-- Header -->
  <div>
    <h1>{{ title }}</h1>
    <ul>
      <li>
        Current User:
        <b style="color: {{ user.profile.map_icon_color }}"
          >{{ request.user }}</b
        >
      </li>
      {% if request.user.is_staff %}
      <li>
        <a
          class="link"
          href="/admin/blog/profile/{{ request.user.profile.id }}/change/"
          target="_blank"
          >Edit Profile</a
        >
      </li>
      {% else %}
      <li>Contact site staff to help change you profile.</li>
      {% endif %}
      <a class="link" href="/manage/blog_post">Back to post list</a>
    </ul>
  </div>
  <!-- Side by Side Holder -->
  <div class="flex gap-x-4">
    <!-- Post Form -->
    <form
      id='post_form'
      class="
        w-72
        md:w-1/2
        max-w-2xl
        bg-gray-100
        p-2
        md:p-4
        rounded
        flex flex-col
        gap-y-2
      "
      action="."
      method="post"
    >
      {% csrf_token %} {% for field in BlogPostForm %}
      <div>
        <div class="font-bold">{{ field.label_tag }}</div>
        <div>{{ field }}</div>
        <div class="field-validation-error">{{ field.errors }}</div>
      </div>
      {% endfor %}
      <div class="validation-summary-errors">{{ form.non_field_errors }}</div>
      <button class="btn-short btn-accent-dark" type="submit">Submit</button>
    </form>
    <!-- Post Preview -->
    <div id='post_preview' class="flex flex-col w-full bg-gray-100 gap-y-2 p-2 md:p-4 rounded">
      <h2>Post Preview</h2>
      <div id="preview">
        {% include 'app/partials/story-header.html' %}
        <div class="post-content w-full max-w-4xl m-auto py-4 px-2">
          {% include 'app/partials/story-content.html' %}
          <div class="bg-gray-300 m-auto p-4 rounded">
            Like, Comment, Subscribe, and Share Buttnons will appear here
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("keyup", generate_preview);

  CKEDITOR.on('load', function(event) {
    const editor = event.editor;
    editor.addCss(`
      .img_caption {
        background-color: black;
      }
    `);
  });

  CKEDITOR.on('instanceCreated', function(event) {
    const editor = event.editor;
    editor.config.contentsCss = [ '/static/app/css/tailwind-output.css' ];


    editor.config.extraAllowedContent = 'div(img_holder,img_caption); img[*]{*}; iframe[*]{*};';
    // editor.config.extraAllowedContent = 'div[class], img[class,src], iframe[width,height,src,frameborder,allow,allowfullscreen]';
    runCallbackOnCkeditorChanges(editor, generate_preview);
    addInsertImageButtonToCkeditor(editor);
    addInsertVideoButtonToCkeditor(editor);
  });

  function generate_preview(e) {
    const post_id = "{{post.id}}";
    console.log(`Generating Preview for Post ID: ${post_id}`);
    
    const previewFields = [
      "title",
      "subtitle",
      "participants",
      "event_date",
      "loc_name",
      "content",
    ];

    for (const previewField of previewFields) {
      let formValue;
      // Get value from form
      if (previewField != 'content') {
        formValue = document.getElementById(`id_${previewField}`).value;
      }
      // Content has to be handled separately due to rich text editor 
      else {
        formValue = CKEDITOR.instances.id_content.getData();
      }
      // Set value in preview
      const previewElement = document.getElementById(
        `post_${post_id}_${previewField}`
      );
      previewElement.innerHTML = formValue;
    }
  }
</script>
{% endblock %}
